require('dotenv').config();
const { Telegraf } = require('telegraf');
const express = require('express');

const bot = new Telegraf(process.env.BOT_TOKEN);
const app = express();

// Middleware Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ JSON
app.use(express.json({ limit: '1mb' }));

// Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ ÐºÐ¾Ð¼Ð°Ð½Ð´
bot.start((ctx) => {
  ctx.reply('ðŸš€ Ð‘Ð¾Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° Vercel!').catch(console.error);
});

bot.command('menu', (ctx) => {
  ctx.reply('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:', {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½', web_app: { url: process.env.WEBAPP_URL } }]
      ]
    }
  }).catch(console.error);
});

// ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð²ÐµÐ±Ñ…ÑƒÐºÐ°
app.post('/api/bot', async (req, res) => {
  try {
    // Ð’Ð°Ð¶Ð½Ð¾: Ð½Ðµ Ð¶Ð´ÐµÐ¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
    bot.handleUpdate(req.body, res);
    
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Telegram ÑÑ€Ð°Ð·Ñƒ
    res.status(200).end();
  } catch (err) {
    console.error('Webhook error:', err);
    res.status(200).end(); // Ð’ÑÐµÐ³Ð´Ð° Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÐ¼ Telegram
  }
});

// Health check endpoint
app.get('/', (req, res) => {
  res.json({ 
    status: 'running',
    timestamp: Date.now()
  });
});

// Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð´Ð»Ñ Vercel
module.exports = app;

// Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº (Ð´Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸)
if (process.env.NODE_ENV === 'development') {
  const PORT = process.env.PORT || 3000;
  app.listen(PORT, () => {
    console.log(`Local server: http://localhost:${PORT}`);
    bot.launch().then(() => console.log('Bot started'));
  });
}